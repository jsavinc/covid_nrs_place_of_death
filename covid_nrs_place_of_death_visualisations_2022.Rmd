---
title: "Place of death in NRS COVID-19 deaths: visualisation for 2022 data"
author: "Jan Savinc"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
  code_folding: hide
toc: true
toc_float: true
editor_options: 
  chunk_output_type: console
---
  
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Load packages

```{r, warning=FALSE, message=FALSE}
## install packages from github if not yet available!
# remotes::install_github("datasciencescotland/opendatascot", force = TRUE)
# remotes::install_github("Health-SocialCare-Scotland/phsmethods", force = TRUE)

library(tidyverse)  # for tidy workflow
library(opendatascot)  # importing data from ScotGov open data website
library(phsmethods)  # methods for working with PHS data
library(readxl)  # for reading excel files
# library(SPARQL)  # taken care of by opendatascot
library(lubridate)  # dealing with dates
library(janitor)  # for cleaning column names
library(ISOweek)  # for computing date from ISO week number + year
library(sf)  # for mapping
library(ggrepel)  # for 'mapping'repelling' labels/texst in ggplot
library(patchwork)  # for assembling plots
library(extrafont)  # for working with fonts
library(openxlsx)  # for creating xlsx files
library(knitr)  # for displaying tables in rmd
library(lemon)  # for showing axis & axis labels in every facet in ggplot
library(ggtext)  # for showing coloured title text

## load functions
source("./functions.R")
```


# Copyright attribution

All data used for this study were obtained from the National Records Scotland (NRS) and are Â© Crown copyright, 2020; the details of the licence can be viewed on the [Open Government Licence website](http://www.nationalarchives.gov.uk/doc/open-government-licence/open-government-licence.htm)


# Dates represent event registration, not occurrence!

From NRS website:
  
  > All routine vital events information we publish is based on the date of registration, not the date on which the event occurred. Inevitably, of course, there are delays between the occurrence of an event and its registration.


# Load most recent data

```{r}
load(file = "./workspace.RData")
```

# Visualisations

## Common elements

```{r}
loadfonts(device="win")  # load imported fonts
# Sys.setenv(R_GSCMD = "C:/Program Files/gs/gs9.27/bin/gswin64c.exe")  # set the location of the GS file  # this not needed, just use device=device_cairo for pdfs in ggsave
windowsFonts("Calibri" = windowsFont("Calibri"))  # to suppress the multiple error messages

theme_set(theme_minimal(base_size = 12) +
            theme(panel.grid.minor = element_blank(),
                  axis.title.y = element_text(margin = margin(0, 20, 0, 0)),  # remove gap to the left of y axis title and below the x axis title
                  axis.title.x = element_text(margin = margin(20, 0, 0, 0)),
                  text=element_text(family="Calibri"),
                  axis.text = element_text(size = 9)
            ))


date_range_text <- glue::glue("Data from w/c {format(earliest_date, '%d %B %Y')} to w/c {format(most_recent_date_available_2022, '%d %B %Y')} (inclusive).")

dashed_line_historical_range_text <- "Range of deaths 2015-19 shown as shaded area; mean shown as dashed line."

only_2020_text <- glue::glue("Data from 2020 included, starting with w/c {format(earliest_date)}.")
only_2022_text <- glue::glue("Data for 2022 only include weeks 1-{format(weeks_available_2022)} (w/c {format(most_recent_date_available_2022)}).")

source_nrs_text <- "Source: National Records of Scotland"
source_phs_text <- "Source: Public Health Scotland"

crude_rate_text <- "Total cases = crude cumulative positive cases over time."

death_registrations_text <- "Note: all figures are based on date of registration."

vertical_line_text <- "Vertical dotted line at week number 54 represents start of 2021."

five_year_historical_mean <- "For 2020-2021 data, the 5-year historical period is 2015-2019; for 2022, the period is 2016-2019 + 2021, skipping 2020."

vertical_scale_differs_between_panels_text <- "Note: vertical axis not on the same scale between panels!"

# removed_other_category_text <- glue::glue("Excluding 'Other' institutional place of death, N={merged_deaths_overall %>% filter(sex == 'all' & age == 'all' & place_of_death == 'Other') %>% .$deaths_all_causes %>% sum} for weeks 1-{max(merged_deaths_overall %>% filter(year==2020) %>% .$week_number)} in 2020 and 1-{max(merged_deaths_overall %>% filter(year==2021) %>% .$week_number)} in 2021.")
removed_other_category_text <- glue::glue("Excluding 'Other' institutional place of death.")

historic_period_2015_2019_text <- "Historic mean & range for 2015-2019 throughout."
historic_period_2022_text <- "2020-21 use 2015-2019 historic mean & range; 2022 uses 2016-2019 & 2021."
```

## Function to save files to multiple formats

Saving to multiple formats is easy enough - the trouble is with saving PDF files with custom fonts, since they need to be embedded in the .pdf file. This requires:
  
  * telling R where to load the font from, using `extrafont::font_import()` - this was done in a previous step
* registering fonts with R using `extrafont::loadfonts()` - note: this isn't strictly necessary, since once imported, `extrafont` keeps track of fonts to load when the `extrafont` package is loaded
* ~~telling R where the `gs` executable is, i.e. the installation of ghostscript on the current machine~~
* ~~embedding the fonts in the `.pdf` files once they've been written, using `extrafont::embed_fonts()`~~
  * instead of manually embedding fonts (which resulted in garbled text on my setup!), just use `device=device_cairo` as an argument to `ggsave()` when saving `.pdf` files and it just works

```{r}
save_output_file <- function(filename, extensions, plot, width, height, units, dpi) {
  
  walk(
    .x = extensions,
    .f = function(ext) {
      # if (tolower(ext)==".pdf") device <- cairo_pdf
      ggsave(filename = paste0(filename, ext), plot = plot, width = width, height = height, units = units, dpi = dpi, device = if (tolower(ext)==".pdf") cairo_pdf else NULL)
    }
  )
}
```

# Place of death over time

```{r}
## to put the arrows explaining historic range etc. only in one panel, need to construct a tibble to pass as data
annotations_fig_place_of_death_explaining_historic_range <- tribble(
   ~geom, ~place_of_death, ~label, ~x, ~y, ~xend, ~yend,
  "text", "Hospital", "Historic range (min & max)", 29, 850, NA, NA,
  "curve", "Hospital", NA, 29, 830, 32, 550,
  "text", "Hospital", "Historic mean", 22, 800, NA, NA,
  "curve", "Hospital", NA, 22, 780, 26, 510
) %>% 
  mutate(across(.cols = c("x","xend"), .fns = ~compute_start_date_from_week_number(week_number = .x, year_number = 2020))) %>%
  mutate(place_of_death = factor(place_of_death, levels = c("Hospital", "Home & other non-institution", "Care home")))  # needs to be factor with same levels, otherwise it messes up level order when added as geom_text later!)


fig_place_of_death <-
  merged_deaths_overall %>%
  filter(sex == "all" & age == "all") %>%
  filter(!place_of_death %in% c("All","Other")) %>%
  mutate(place_of_death = factor(place_of_death, levels = c("Hospital", "Home & other non-institution", "Care home"))) %>%  # needs to be factor with same levels, otherwise it messes up level order when added as geom_text later!)
  pivot_longer(cols = c(deaths_all_causes, deaths_non_covid), 
               names_to = "deaths_type", values_to = "deaths") %>% 
  ggplot(aes(x = date_w_c)) +
  geom_vline(xintercept = compute_start_date_from_week_number(week_number = 1, year_number = 2021), linetype = "dashed", colour="grey50") +  # start of 2021
  geom_vline(xintercept = compute_start_date_from_week_number(week_number = 1, year_number = 2022), linetype = "dashed", colour="grey50") +  # start of 2022
  scale_x_date(date_labels = "%d-%m-%y", date_breaks = "12 weeks", limits = c(earliest_date, most_recent_date_available_2022)) +
  geom_ribbon(aes(ymin = deaths_min, ymax = deaths_max), fill = "#4477aa", alpha = 0.5) +
  geom_line(aes(y = deaths, colour = deaths_type)) +
  geom_line(aes(y = deaths_mean), linetype = "dashed", colour="grey20") +
  facet_grid(~place_of_death) +
  scale_colour_manual(values = c("red","blue"),  # custom legend for the two lines
                      labels = c("All deaths", 
                                 "Non Covid-19 deaths"),
                      guide = guide_legend(label.hjust = 0.5, override.aes = list(size = 5))
                      ) +
  theme(
    legend.position = "top",
    plot.caption = element_text(size = 10, colour = "gray60"),
    plot.margin = margin(5, 15, 5, 5),
    axis.text.x = element_text(angle = 60, colour = "gray40", vjust=1, hjust=1)
  ) +
  labs(x = NULL,
       y = "Deaths (N)",
       subtitle = date_range_text,
       caption = paste0(c(death_registrations_text,removed_other_category_text,source_nrs_text), collapse="\n"),
       colour = "Cause of death"
       ) +
  ## annotate historic range
  geom_text(data = annotations_fig_place_of_death_explaining_historic_range %>% filter(geom=="text"), aes(x=x, y=y, label=label),  colour = "grey20", size = 8 / (14/5)) +  # the size is tricky
  geom_curve(data = annotations_fig_place_of_death_explaining_historic_range %>% filter(geom=="curve"), aes(x=x, y=y, xend=xend, yend=yend), colour = c("#4477aa", "grey20"), alpha = c(0.5, 1), curvature = 0.20, arrow = arrow(length = unit(0.2, "cm"))) +
  annotate(geom = "text", x=ymd("2021-01-07"), y=30, label = "2021", hjust = 0, colour = "grey40") +
  annotate(geom = "text", x=ymd("2022-01-07"), y=30, label = "'22", hjust = 0, colour = "grey40") +
  NULL

fig_place_of_death %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_place_of_death", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 28, height = 14, dpi = 300, units = "cm")
```

## Home deaths only

```{r}
fig_place_of_death_home_only <-
  merged_deaths_overall %>%
  filter(sex == "all" & age == "all") %>%
  filter(place_of_death %in% c("Home & other non-institution")) %>%  # home death only
  mutate(place_of_death = factor(place_of_death, levels = c("Hospital", "Home & other non-institution", "Care home"))) %>%  # needs to be factor with same levels, otherwise it messes up level order when added as geom_text later!)
  pivot_longer(cols = c(deaths_all_causes, deaths_non_covid), 
               names_to = "deaths_type", values_to = "deaths") %>% 
  ggplot(aes(x = date_w_c)) +
  geom_vline(xintercept = compute_start_date_from_week_number(week_number = 1, year_number = 2021), linetype = "dashed", colour="grey50") +  # start of 2021
  geom_vline(xintercept = compute_start_date_from_week_number(week_number = 1, year_number = 2022), linetype = "dashed", colour="grey50") +  # start of 2022
  scale_x_date(date_labels = "%d-%m-%y", date_breaks = "12 weeks", limits = c(earliest_date, most_recent_date_available_2022)) +
  geom_ribbon(aes(ymin = deaths_min, ymax = deaths_max), fill = "#4477aa", alpha = 0.5) +
  geom_line(aes(y = deaths, colour = deaths_type)) +
  geom_line(aes(y = deaths_mean), linetype = "dashed", colour="grey20") +
  facet_grid(~place_of_death) +
  scale_colour_manual(values = c("red","blue"),  # custom legend for the two lines
                      labels = c("All deaths", 
                                 "Non Covid-19 deaths"),
                      guide = guide_legend(label.hjust = 0.5, override.aes = list(size = 5))
                      ) +
  theme(
    legend.position = "top",
    legend.title = element_blank(),
    plot.caption = element_text(size = 10, colour = "gray60"),
    plot.margin = margin(5, 15, 5, 5),
    axis.text.x = element_text(angle = 60, colour = "gray40", vjust=1, hjust=1)
  ) +
  labs(x = NULL,
       y = "Deaths (N)",
       subtitle = date_range_text,
       caption = paste0(c(death_registrations_text,historic_period_2022_text,source_nrs_text), collapse="\n")
       ) +
  ## annotate historic range
  annotate(geom="text",x = compute_start_date_from_week_number(week_number = 20, year_number = 2020), y = 50, label = "Historic range (min & max)", colour = "grey20") +
  annotate(geom="curve",x = compute_start_date_from_week_number(week_number = 29, year_number = 2020), xend = compute_start_date_from_week_number(week_number = 33, year_number = 2020), y = 65, yend = 210, curvature = 0.20, colour = "#4477aa", alpha = 0.5, arrow = arrow(length = unit(0.2, "cm"))) +
  annotate(geom="text", x = compute_start_date_from_week_number(week_number = 20, year_number = 2020), y = 100, label = "Historic mean", colour = "grey20") +
  annotate(geom="curve",x = compute_start_date_from_week_number(week_number = 22, year_number = 2020), xend = compute_start_date_from_week_number(week_number = 25, year_number = 2020), y = 115, yend = 270, curvature = 0.20, colour = "grey20", linetype="dashed", arrow = arrow(length = unit(0.2, "cm"))) +
  annotate(geom = "text", x=ymd("2021-01-07"), y=30, label = "2021", hjust = 0, colour = "grey40") +
  annotate(geom = "text", x=ymd("2022-01-07"), y=30, label = "'22", hjust = 0, colour = "grey40") +
  NULL

fig_place_of_death_home_only %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_place_of_death_home_only", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 18, height = 14, dpi = 300, units = "cm")
```

### Home deaths with 2015-2019 historic period means & range only

```{r}
merged_deaths_overall_2015_2019_historic_period <-
  bind_rows(
    ## pre-2022 data
    merged_deaths_overall %>% filter(year < 2022),
    ## 2022 data
    merged_deaths_overall %>%
      filter(year >= 2022) %>%  # 2022 or later!?
      select(-matches("deaths\\_mean|deaths\\_min|deaths\\_max")) %>%  # remove data using NRS historic period
      mutate(historic_period = "2015-2019") %>%  # join the previous hsitoric period data instead
      left_join(historical_weekly_average_overall, by = c("historic_period","week_number","place_of_death")) %>%
      compute_moving_average_for_current_data(  # not strictly required here but will be easier to apply in other places if included
        current_data = ., 
        historical_data = 
          weekly_deaths_2015_2019_overall %>% mutate(year=as.integer(year)) %>% drop_na(year),  # remove the entries with 'average' for year
        num_weeks_to_average = 4)
  )


fig_place_of_death_home_2015_2019_historic_period <-
  merged_deaths_overall_2015_2019_historic_period %>%
  filter(sex == "all" & age == "all") %>%
  filter(place_of_death %in% c("Home & other non-institution")) %>%  # home death only
  mutate(place_of_death = factor(place_of_death, levels = c("Hospital", "Home & other non-institution", "Care home"))) %>%  # needs to be factor with same levels, otherwise it messes up level order when added as geom_text later!)
  pivot_longer(cols = c(deaths_all_causes, deaths_non_covid), 
               names_to = "deaths_type", values_to = "deaths") %>% 
  ggplot(aes(x = date_w_c)) +
  geom_vline(xintercept = compute_start_date_from_week_number(week_number = 1, year_number = 2021), linetype = "dashed", colour="grey50") +  # start of 2021
  geom_vline(xintercept = compute_start_date_from_week_number(week_number = 1, year_number = 2022), linetype = "dashed", colour="grey50") +  # start of 2022
  scale_x_date(date_labels = "%d-%m-%y", date_breaks = "12 weeks", limits = c(earliest_date, most_recent_date_available_2022)) +
  geom_ribbon(aes(ymin = deaths_min, ymax = deaths_max), fill = "#4477aa", alpha = 0.5) +
  geom_line(aes(y = deaths, colour = deaths_type)) +
  geom_line(aes(y = deaths_mean), linetype = "dashed", colour="grey20") +
  facet_grid(~place_of_death) +
  scale_colour_manual(values = c("red","blue"),  # custom legend for the two lines
                      labels = c("All deaths", 
                                 "Non Covid-19 deaths"),
                      guide = guide_legend(label.hjust = 0.5, override.aes = list(size = 5))
                      ) +
  theme(
    legend.position = "top",
    legend.title = element_blank(),
    plot.caption = element_text(size = 10, colour = "gray60"),
    plot.margin = margin(5, 15, 5, 5),
    axis.text.x = element_text(angle = 60, colour = "gray40", vjust=1, hjust=1)
  ) +
  labs(x = NULL,
       y = "Deaths (N)",
       subtitle = date_range_text,
       caption = paste0(c(death_registrations_text,historic_period_2015_2019_text,source_nrs_text), collapse="\n")
       ) +
  ## annotate historic range
  annotate(geom="text",x = compute_start_date_from_week_number(week_number = 20, year_number = 2020), y = 50, label = "Historic range (min & max)", colour = "grey20") +
  annotate(geom="curve",x = compute_start_date_from_week_number(week_number = 29, year_number = 2020), xend = compute_start_date_from_week_number(week_number = 33, year_number = 2020), y = 65, yend = 210, curvature = 0.20, colour = "#4477aa", alpha = 0.5, arrow = arrow(length = unit(0.2, "cm"))) +
  annotate(geom="text", x = compute_start_date_from_week_number(week_number = 20, year_number = 2020), y = 100, label = "Historic mean", colour = "grey20") +
  annotate(geom="curve",x = compute_start_date_from_week_number(week_number = 22, year_number = 2020), xend = compute_start_date_from_week_number(week_number = 25, year_number = 2020), y = 115, yend = 270, curvature = 0.20, colour = "grey20", linetype="dashed", arrow = arrow(length = unit(0.2, "cm"))) +
  annotate(geom = "text", x=ymd("2021-01-07"), y=30, label = "2021", hjust = 0, colour = "grey40") +
  annotate(geom = "text", x=ymd("2022-01-07"), y=30, label = "2022", hjust = 0, colour = "grey40") +
  NULL

fig_place_of_death_home_2015_2019_historic_period %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_place_of_death_home_2015-2019_range", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 18, height = 14, dpi = 300, units = "cm")
```


# Proportion annual deaths by place

Here we'll show 4 lines, one for each place of death, for each year so far.

```{r}
(fig_proportion_annual_deaths_by_place <-
  merged_proportions_of_deaths_by_place %>%
  mutate(place_of_death = factor(x = place_of_death, levels = order_of_place_of_death_levels[c(1,3,2,4)])) %>%  # move home to 2nd position to match order in plot
  ggplot(., aes(x=year, y=proportion_of_total, colour=place_of_death)) +
  geom_point() +
  geom_line(size = 1) +
  geom_text(data = ~filter(.x, year==2022), aes(x=2022.2, y=proportion_of_total, label="*"), inherit.aes = FALSE) +
  scale_x_continuous(breaks = sort(unique(merged_proportions_of_deaths_by_place$year))) +
  scale_y_continuous(label = function(x) scales::percent(x = x, accuracy = 1)) +
  scale_colour_viridis_d(option="C") +
  # theme_minimal() +
  theme(
    legend.position = "top", 
    plot.caption = element_text(size = 10, colour = "gray60")
    ) +
  labs(
    x = "Year", y = "Proportion of yearly deaths (%)",
    colour = NULL,
    subtitle = paste0("* ",only_2022_text),
    caption = paste0(c(death_registrations_text,source_nrs_text),collapse="\n")
    ) +
  guides(colour = guide_legend(nrow=2)) +  # spread colour legend over two rows
  NULL
)
fig_proportion_annual_deaths_by_place %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_proportion_annual_deaths_by_place", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 13, height = 10, dpi = 300, units = "cm")
```


# Proportion of cumulative deaths by place, over the course of a year

First we compute the cumulative proportion of place of death within each year. As the weeks go by, the proportions of deaths in each place change, and they change at different rates.

```{r}
cumulative_deaths_by_place_by_year <-
  bind_rows(
    ## current data
    merged_deaths_overall %>%
      filter(age == "all" & sex == "all"),
    ## 2015-2019
    weekly_deaths_2015_2019_overall %>%
      mutate(year = as.integer(year)) %>%  # remove the 'average' figures
      drop_na(year) %>%
      rename(deaths_all_causes = number_of_deaths)
  ) %>%
  arrange(year, week_number) %>%
  group_by(year, place_of_death) %>%
  mutate(
    cumulative_deaths = cumsum(deaths_all_causes)
  ) %>%
  group_by(year, week_number, place_of_death == "All"
  ) %>%
  mutate(
    proportion_cumulative_deaths = cumulative_deaths / sum(cumulative_deaths)
  ) %>%
  ungroup %>%
  select(year, place_of_death, week_number, matches("cumulative_deaths"))

cumulative_deaths_by_place_by_year_min_max_2015_2019 <-
  cumulative_deaths_by_place_by_year %>%
  filter(year %in% 2015:2019) %>%
  group_by(place_of_death, week_number) %>%
  summarise(
    proportion_cumulative_deaths_min = min(proportion_cumulative_deaths),
    proportion_cumulative_deaths_max = max(proportion_cumulative_deaths),
    .groups = "drop"
  )
```


## Weekly proportion of deaths by place

These are non-cumulative proportions of place of death for each week. You can see how the proportions of place of death are fairly noisy over time, and in 2015-2019 they are relatively stable; it's not until 2020 that a big shift occurs.

```{r}
fig_weekly_proportion_of_death_by_place <-
  bind_rows(
    ## current data
    merged_deaths_overall %>%
      filter(age == "all" & sex == "all"),
    ## 2015-2019
    weekly_deaths_2015_2019_overall %>%
      mutate(year = as.integer(year)) %>%  # remove the 'average' figures
      drop_na(year) %>%
      rename(deaths_all_causes = number_of_deaths)
  ) %>%
  group_by(year, week_number, place_of_death == "All") %>%
  mutate(proportion_of_deaths = deaths_all_causes / sum(deaths_all_causes)) %>%
  ungroup %>%
  filter(place_of_death != "All") %>%
  mutate(place_of_death = factor(x = place_of_death, levels = order_of_place_of_death_levels[c(1,3,2,4)])) %>%  # move home to 2nd position to match order in plot
  ggplot(
    data = ., aes(x = week_number, y = proportion_of_deaths, colour = place_of_death)
  ) +
  geom_line() +
  facet_wrap(~year) +
  scale_colour_viridis_d() +
  scale_x_continuous(breaks = scales::breaks_extended(6)) +
  scale_y_continuous(breaks = scales::breaks_extended(6), label = function(x) scales::percent(x = x, accuracy = 1)) +
  theme(
    legend.position = "top",
    legend.title = element_blank(),
    plot.caption = element_text(size = 10, colour = "gray60"),
  ) +
  labs(
    x = "Week number", y = "Weekly proportion of deaths (%)",
    colour = NULL,
    subtitle = paste0("* ",only_2022_text),
    caption = paste0(c(death_registrations_text,source_nrs_text),collapse="\n")
  ) +
  NULL

fig_weekly_proportion_of_death_by_place %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_weekly_proportion_of_death_by_place", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 20, height = 15, dpi = 300, units = "cm")
```


## Yearly graphs, 2015-2022

This is a graph to see whether the relative proportion of deaths by place changes over time - we know the annual proportions for the 4 places of death, for example, but their relative proportion changes over the year.
This gives us context to be able to decide whether a decline in home deaths early in the year represents a genuine decline or just the general trend of home deaths being lower early in a year.


```{r}
fig_cumulative_weekly_proportion_of_deaths_by_place <-
  cumulative_deaths_by_place_by_year %>%
  filter(place_of_death != "All") %>%
  mutate(place_of_death = factor(x = place_of_death, levels = order_of_place_of_death_levels[c(1,3,2,4)])) %>%  # move home to 2nd position to match order in plot
  ggplot(data = ., aes(x = week_number, y = proportion_cumulative_deaths, group = place_of_death, colour = place_of_death)) +
  geom_line() +
  facet_wrap(~year) +
  scale_colour_viridis_d() +
  scale_fill_viridis_d() +
  scale_x_continuous(breaks = scales::breaks_extended(6)) +
  scale_y_continuous(breaks = scales::breaks_extended(6), label = function(x) scales::percent(x = x, accuracy = 1)) +
  theme(
    legend.position = "top",
    legend.title = element_blank(),
    plot.caption = element_text(size = 10, colour = "gray60"),
  ) +
  labs(
    x = "Week number", y = "Cumulative proportion of place of death (%)",
    colour = NULL,
    subtitle = paste0("* ",only_2022_text),
    caption = paste0(c(death_registrations_text,source_nrs_text),collapse="\n")
  ) +
  NULL

fig_cumulative_weekly_proportion_of_deaths_by_place %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_cumulative_weekly_proportion_of_deaths_by_place", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 20, height = 15, dpi = 300, units = "cm")
```

## Cumulative proportion of place of death, showing 2015-2019 as range

This is a similar graph to the above, but we include the weekly range (min/max) of the weekly proportions of place of death, as historic context for the data from 2020 onwards.

```{r}
fig_cumulative_weekly_proportion_of_deaths_by_place_with_historic_range <-
  cumulative_deaths_by_place_by_year %>%
  filter(place_of_death != "All") %>%
  filter(!year %in% 2015:2019) %>%
  left_join(cumulative_deaths_by_place_by_year_min_max_2015_2019, by = c("week_number", "place_of_death")) %>%
  mutate(place_of_death = factor(x = place_of_death, levels = order_of_place_of_death_levels[c(1,3,2,4)])) %>%  # move home to 2nd position to match order in plot
  ggplot(data = ., aes(x = week_number, y = proportion_cumulative_deaths, group = place_of_death, colour = place_of_death)) +
  geom_line() +
  geom_ribbon(aes(ymin = proportion_cumulative_deaths_min, ymax = proportion_cumulative_deaths_max, fill = place_of_death, colour = NULL), alpha = 0.4) +
  facet_wrap(~year) +
  scale_colour_viridis_d() +
  scale_fill_viridis_d() +
  scale_x_continuous(breaks = scales::breaks_extended(6)) +
  scale_y_continuous(label = function(x) scales::percent(x = x, accuracy = 1)) +
  theme(
    legend.position = "top",
    legend.title = element_blank(),
    plot.caption = element_text(size = 10, colour = "gray60"),
  ) +
  labs(
    x = "Week number", y = "Cumulative proportion of place of death (%)",
    subtitle = paste0("* ",only_2022_text),
    caption = paste0(c("Shaded areas represent the range of cumulative weekly proportion of deaths by place for the 2015-2019 period",death_registrations_text, source_nrs_text),collapse="\n")
  ) +
  NULL

fig_cumulative_weekly_proportion_of_deaths_by_place_with_historic_range %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_cumulative_weekly_proportion_of_deaths_by_place_with_historic_range", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 20, height = 15, dpi = 300, units = "cm")
```

# Causes of death compared to historic context

Here I first merge the 2022 data series with the historic period 2015-2019 averages for weekly figures - this way we can compare the total in 2022 so far with the historical figures up to the same week.

```{r}
merged_deaths_cause_of_death_with_2015_2019_historic_period <-
  bind_rows(
    merged_deaths_cause_of_death %>%
      filter(year %in% 2020:2021)
    ,
    merged_deaths_cause_of_death %>%
      filter(year == 2022) %>%
      select(-c(historic_period,deaths_mean)) %>%
      left_join(
        merged_deaths_cause_of_death %>%
          filter(year==2021) %>%
          select(place_of_death, week_number, cause_of_death, historic_period, deaths_mean),
        by = c("place_of_death", "week_number", "cause_of_death")
      )
  )

total_deaths_cause_of_death_so_far <-
  merged_deaths_cause_of_death_with_2015_2019_historic_period %>%
  group_by(year, cause_of_death, place_of_death, historic_period) %>%
  summarise(
    number_of_deaths = sum(number_of_deaths, na.rm = TRUE),
    deaths_mean = sum(deaths_mean, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  group_by(year, place_of_death, historic_period) %>%
  mutate(
    proportion_all_deaths = number_of_deaths / sum(number_of_deaths, na.rm = TRUE),
    proportion_all_deaths_historic = deaths_mean / sum(deaths_mean, na.rm = TRUE)
  ) %>%
  ungroup
```

## Cuases so far by place


```{r}
(fig_deaths_so_far_by_cause <-
  total_deaths_cause_of_death_so_far %>%
  filter(!place_of_death %in% c("Other","All")) %>%
  group_by(cause_of_death, place_of_death, historic_period) %>%
  summarise(
    number_of_deaths = sum(number_of_deaths, na.rm = TRUE),
    deaths_mean = sum(deaths_mean, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  group_by(place_of_death, historic_period) %>%
  mutate(
    proportion_all_deaths = number_of_deaths / sum(number_of_deaths, na.rm = TRUE),
    proportion_all_deaths_historic = deaths_mean / sum(deaths_mean, na.rm = TRUE)
  ) %>%
  ungroup %>%
  mutate(
     cause_of_death = fct_rev(factor(cause_of_death)),
     place_of_death = factor(place_of_death, levels = c("Hospital", "Home & other non-institution", "Care home"))
     ) %>%
  ggplot() +
  geom_col(aes(y = cause_of_death, fill = cause_of_death, x = number_of_deaths), alpha = 0.8, colour = "grey10") +
  geom_segment(aes(y = as.numeric(cause_of_death)-0.45, yend = as.numeric(cause_of_death)+0.45, x = deaths_mean, xend = deaths_mean), size = 0.8, colour = "grey1") +
  scale_fill_viridis_d() +
  facet_grid(~place_of_death) +
  scale_x_continuous(labels = function(x) format(x, big.mark = ",")) +
  scale_y_discrete(labels = ~str_wrap(.x, width = 20)) +
  theme(
    legend.position = "none", 
    plot.caption = element_text(size = 10, colour = "gray60"),
    legend.title = element_blank(), 
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank()
    ) +
  labs(
    x = NULL, y = NULL,
    title = str_wrap("Total deaths since start of 2020 by cause and place of death, compared to 2015-2019", width = 60),
    subtitle = paste0(c("Bars are no. of deaths, line segments are mean annual deaths 2015-2019", paste0("* ",only_2022_text)), collapse="\n"),
    caption = paste0(c(death_registrations_text, source_nrs_text),collapse="\n")
  ) +
  NULL)

fig_deaths_so_far_by_cause %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_deaths_so_far_by_cause", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 18, height = 12, dpi = 300, units = "cm")
```


## Causes by place & year

```{r}
(fig_annual_deaths_by_cause <-
  total_deaths_cause_of_death_so_far %>%
  filter(!place_of_death %in% c("Other","All")) %>%
  mutate(
     cause_of_death = fct_rev(factor(cause_of_death)),
     place_of_death = factor(place_of_death, levels = c("Hospital", "Home & other non-institution", "Care home"))
     ) %>%
  ggplot() +
  geom_col(aes(y = cause_of_death, fill = cause_of_death, x = number_of_deaths), alpha = 0.8, colour = "grey10") +
  geom_segment(aes(y = as.numeric(cause_of_death)-0.45, yend = as.numeric(cause_of_death)+0.45, x = deaths_mean, xend = deaths_mean), size = 0.8, colour = "grey1") +
  scale_fill_viridis_d() +
  facet_grid(year~place_of_death) +
  scale_x_continuous(labels = function(x) format(x, big.mark = ",")) +
  scale_y_discrete(labels = ~str_wrap(.x, width = 20)) +
  theme(
    legend.position = "none", 
    plot.caption = element_text(size = 10, colour = "gray60"),
    legend.title = element_blank(), 
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank()
    ) +
  labs(
    x = NULL, y = NULL,
    title = "Annual deaths by cause and place of death, compared to 2015-2019",
    subtitle = paste0(c("Bars are no. of deaths, line segments are mean annual deaths 2015-2019", paste0("* ",only_2022_text)), collapse="\n"),
    caption = paste0(c(death_registrations_text, source_nrs_text),collapse="\n")
  ) +
  NULL)

fig_annual_deaths_by_cause %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_annual_deaths_by_cause", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 20, height = 15, dpi = 300, units = "cm")
```


# Causes of death over time

## Proportion of causes by place, yearly

This graph shows each of the causes of death divided by place of death - e.g. what proportion of cancer deaths happened at home vs hospital over time?

```{r}
fig_cause_of_death_annual_proportion_by_place <-
  current_and_historical_deaths_by_cause_and_location %>%
  filter(!cause_of_death %in% c("All")) %>%
  filter(!year %in% c("2020-2021")) %>%
  mutate(place_of_death = factor(place_of_death, levels = c("Hospital", "Home & other non-institution", "Care home", "Other"))) %>%  # needs to be factor with same levels, otherwise it messes up level order when added as geom_text later!)
  mutate(
   cause_of_death = factor(cause_of_death %>% str_wrap(., width = 15), levels = order_of_causes_of_death %>% str_wrap(., width = 15)),  # needed to allow converting to a number for plotting the line segments; str_wrap breaks the text up into lines
  ) %>%
  ggplot(aes(x = year, y = proportion, colour = place_of_death, group = place_of_death)) +
  geom_line() +
  geom_point() +
  geom_text(data = ~filter(.x, year==2022), aes(x=4.2, y=proportion, label="*"), inherit.aes = FALSE) +  # 4.2 here is 4th (final) place on the scale!
  facet_rep_wrap(~cause_of_death, repeat.tick.labels = TRUE) +
  scale_colour_viridis_d() +
  scale_y_continuous(labels = function(x) scales::percent(x, accuracy = 1)) +
  labs(
    x = "Year",
    y = "Percentage yearly deaths by place (%)",
    title = "In 2020 and 2021 the share of deaths at <b style='color:#31688E;'>Home</b> increased for all causes.\nDuring the pandemic, more cancer deaths happened at <b style='color:#31688E;'>Home</b> than in <b style='color:#440154;'>Hospital</b>.",
    subtitle = paste0("\n* ",only_2022_text),
    caption = paste0(c("The 2015-2019 number of deaths is the annual mean for the period.",death_registrations_text,source_nrs_text), collapse = "\n")
  ) +
  theme(
    panel.spacing = unit(1, units = "lines"),
    legend.position = "top", legend.title = element_blank(),
    plot.title = element_textbox_simple()  # to render the html in the title
    ) +
  guides(colour = guide_legend(nrow=2)) +  # spread colour legend over two rows
  NULL

fig_cause_of_death_annual_proportion_by_place %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_cause_of_death_annual_proportion_by_place", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 20, height = 15, dpi = 300, units = "cm")
```


## Weekly proportion of deaths by place

This is the same idea as above, but looking at weekly proportions of cause of death by place - where did deaths due to different causes happen, and did their proportion vary over the year (e.g. seasonal effects)

```{r}
fig_cause_of_death_weekly_proportion_by_place <-
  merged_deaths_cause_of_death %>%
  filter(!cause_of_death %in% c("All")) %>%
  mutate(place_of_death = factor(place_of_death, levels = c("Hospital", "Home & other non-institution", "Care home", "Other", "All"))) %>%  # needs to be factor with same levels, otherwise it messes up level order when added as geom_text later!)
  mutate(
   cause_of_death = factor(cause_of_death %>% str_wrap(., width = 15), levels = order_of_causes_of_death %>% str_wrap(., width = 15)),  # needed to allow converting to a number for plotting the line segments; str_wrap breaks the text up into lines
  ) %>%
  group_by(year, week_number, cause_of_death, place_of_death != "All") %>%
  mutate(proportion_weekly_total = number_of_deaths / sum(number_of_deaths)) %>%
  ungroup %>%
  filter(place_of_death != "All") %>%
  ggplot(aes(x = date_w_c, y = proportion_weekly_total, colour = place_of_death, group = place_of_death)) +
  geom_line() +
  annotate(geom = "text", x=ymd("2021-01-14"), y=0.95, label = "2021", hjust = 0, colour = "grey40") +
  annotate(geom = "text", x=ymd("2022-01-14"), y=0.95, label = "'22", hjust = 0, colour = "grey40") +
  geom_vline(xintercept = compute_start_date_from_week_number(week_number = 1, year_number = 2021), linetype = "dashed", colour="grey50") +  # start of 2021
  geom_vline(xintercept = compute_start_date_from_week_number(week_number = 1, year_number = 2022), linetype = "dashed", colour="grey50") +  # start of 2022
  facet_rep_wrap(~cause_of_death, repeat.tick.labels = TRUE, ncol = 2) +
  scale_colour_viridis_d() +
  scale_x_date(date_labels = "%d-%m-%y", date_breaks = "12 weeks", limits = c(earliest_date, most_recent_date_available_2022)) +
  scale_y_continuous(labels = function(x) scales::percent(x, accuracy = 1)) +
  labs(
    x = "Year",
    y = "Percentage weekly deaths by place (%)",
    # title = "In 2020 and 2021 the share of deaths at <b style='color:#31688E;'>Home</b> increased for all causes.\nDuring the pandemic, more cancer deaths happened at <b style='color:#31688E;'>Home</b> than in <b style='color:#440154;'>Hospital</b>.",
    subtitle = paste0("\n* ",only_2022_text),
    caption = paste0(c("The 2015-2019 figures are average weekly deaths.",death_registrations_text,source_nrs_text), collapse = "\n")
  ) +
  theme(
    panel.spacing = unit(1, units = "lines"),
    legend.position = "top", legend.title = element_blank(),
    plot.title = element_textbox_simple(),  # to render the html in the title
    axis.text.x = element_text(angle = 60, colour = "gray40", vjust=1, hjust=1)
    ) +
  guides(colour = guide_legend(nrow=2)) +  # spread colour legend over two rows
  NULL

fig_cause_of_death_weekly_proportion_by_place %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_cause_of_death_weekly_proportion_by_place", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 25, height = 30, dpi = 300, units = "cm")
```

### With 2015-2019 context also

```{r}
(fig_weekly_proportion_of_death_by_place_with_2015_2019 <-
  bind_rows(
    ## 2020 onwards
    merged_deaths_cause_of_death %>%
      mutate(
        year = as.character(year),
        week_number_run_over = week_number_run_over + 53  # push 2020+ forward by a year, to 'squeeze' in the historic period year
        )
    ,
    ## 2015-2019 data, weekly averages make up one "year"
    merged_deaths_cause_of_death %>%
      filter(year==2020) %>%
      mutate(
        year = "2015-2019",
        number_of_deaths = deaths_mean
        )
  ) %>%
  mutate(year = factor(year, levels = c("2015-2019",as.character(2020:2022)))) %>%
  filter(!cause_of_death %in% c("All")) %>%
  mutate(place_of_death = factor(place_of_death, levels = c("Hospital", "Home & other non-institution", "Care home", "Other", "All"))) %>%  # needs to be factor with same levels, otherwise it messes up level order when added as geom_text later!)
  mutate(
   cause_of_death = factor(cause_of_death %>% str_wrap(., width = 15), levels = order_of_causes_of_death %>% str_wrap(., width = 15)),  # needed to allow converting to a number for plotting the line segments; str_wrap breaks the text up into lines
  ) %>%
  group_by(year, week_number, cause_of_death, place_of_death != "All") %>%
  mutate(proportion_weekly_total = number_of_deaths / sum(number_of_deaths)) %>%
  ungroup %>%
  filter(place_of_death != "All") %>%
  ggplot(aes(x = week_number_run_over, y = proportion_weekly_total, colour = place_of_death, group = place_of_death)) +
  geom_line() +
  # annotate(geom = "text", x=1+1, y=0.95, label = "2015-19", hjust = 0, colour = "grey40") +
  # annotate(geom = "text", x=54+1, y=0.95, label = "2020", hjust = 0, colour = "grey40") +
  # annotate(geom = "text", x=107+1, y=0.95, label = "2021", hjust = 0, colour = "grey40") +
  # annotate(geom = "text", x=159+1, y=0.95, label = "'22", hjust = 0, colour = "grey40") +
  facet_rep_wrap(~cause_of_death, repeat.tick.labels = TRUE, ncol = 2) +
  scale_colour_viridis_d() +
  scale_x_continuous(breaks = c(1,54,107,159), labels = c("2015-2019",as.numeric(2020:2022))) +
  scale_y_continuous(labels = function(x) scales::percent(x, accuracy = 1)) +
  labs(
    x = "Year",
    y = "Percentage weekly deaths by place (%)",
    subtitle = paste0("\n* ",only_2022_text),
    caption = paste0(c("The 2015-2019 figures are average weekly deaths",death_registrations_text,source_nrs_text), collapse = "\n")
  ) +
  theme(
    panel.spacing = unit(1, units = "lines"),
    legend.position = "top", legend.title = element_blank(),
    plot.title = element_textbox_simple(),  # to render the html in the title
    axis.text.x = element_text(angle = 60, colour = "gray40", vjust=1, hjust=1)
    ) +
  guides(colour = guide_legend(nrow=2)) +  # spread colour legend over two rows
  NULL
)
fig_weekly_proportion_of_death_by_place_with_2015_2019 %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_cause_of_death_weekly_proportion_by_place_2015_2019", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 25, height = 30, dpi = 300, units = "cm")
```



## Weekly deaths by cause, at home

```{r}
annotations_for_2021_and_2022_in_home_deaths_by_cause <-
  merged_deaths_cause_of_death %>%
  filter(str_starts(place_of_death,"Home")) %>%
  filter(cause_of_death != "All") %>%
  group_by(cause_of_death) %>%
  summarise(max = max(number_of_deaths), .groups = "drop")

fig_weekly_deaths_by_cause_at_home <-
  merged_deaths_cause_of_death %>%
  filter(str_starts(place_of_death,"Home")) %>%
  filter(cause_of_death != "All") %>%
  mutate(deaths_mean = if_else(historic_period=="2015-2019" & cause_of_death=="COVID-19", NA_real_, deaths_mean)) %>%  # set historic covid deaths to NA for 2020-2021
  pivot_longer(cols = c(deaths_mean, number_of_deaths), names_to = "deaths_type", values_to = "number_of_deaths") %>%
  mutate(deaths_type = if_else(deaths_type == "deaths_mean", true = "Historic mean 2015-2019", false = "Deaths in 2020 & 2021")) %>%
  filter(!(deaths_type=="deaths_mean" & cause_of_death=="COVID-19")) %>%  # remove historical average for covid, it's 0 anyway
  mutate(place_of_death = factor(place_of_death, levels = c("Hospital", "Home & other non-institution", "Care home"))) %>%  # needs to be factor with same levels, otherwise it messes up level order when added as geom_text later!)
  ggplot(aes(x = date_w_c)) +
  scale_x_date(date_labels = "%d-%m-%y", date_breaks = "12 weeks", limits = c(earliest_date, most_recent_date_available_2022)) +
  # geom_line(aes(y = number_of_deaths, colour = deaths_type, linetype = deaths_type)) +
  geom_line(aes(y = number_of_deaths, colour = deaths_type)) +
  geom_vline(xintercept = compute_start_date_from_week_number(week_number = 1, year_number = 2021), linetype = "dotted", colour="grey70") +  # start of 2021
  geom_vline(xintercept = compute_start_date_from_week_number(week_number = 1, year_number = 2022), linetype = "dotted", colour="grey70") +  # start of 2022
  # scale_linetype_manual(values = c("solid", "dashed")) +
  scale_colour_manual(values = c("grey10","grey50")) +
  geom_text(data = annotations_for_2021_and_2022_in_home_deaths_by_cause, aes(y = max), x = ymd("2021-01-20"), label = "2021", hjust = 0) +
  geom_text(data = annotations_for_2021_and_2022_in_home_deaths_by_cause, aes(y = max), x = ymd("2022-01-20"), label = "'22", hjust = 0) +
  facet_wrap(cause_of_death~., scales = "free_y") +
  theme(
    legend.position = "top",
    legend.title = element_blank(),
    plot.caption = element_text(size = 10, colour = "gray60"),
    plot.margin = margin(5, 15, 5, 5),
    axis.text.x = element_text(angle = 60, colour = "gray40", vjust=1, hjust=1)
  ) +
  labs(x = "Date w/c",
       y = "Weekly Deaths (N)",
       subtitle = paste0(c("Deaths registered at home", date_range_text), collapse = "\n"),
       caption = paste0(c("Note that y-axis scale varies across panels!",death_registrations_text,source_nrs_text), collapse="\n")
       ) +
  NULL
  
fig_weekly_deaths_by_cause_at_home %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_weekly_deaths_by_cause_at_home", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 24, height = 18, dpi = 300, units = "cm")
```


# Deviation from mean

```{r}
fig_place_of_death_deviation_from_mean <-
  merged_deaths_overall %>%
  filter(sex == "all" & age == "all") %>%
  filter(!place_of_death %in% c("All","Other")) %>%
  mutate(place_of_death = factor(place_of_death, levels = c("Hospital", "Home & other non-institution", "Care home"))) %>%  # needs to be factor with same levels, otherwise it messes up level order when added as geom_text later!)
  pivot_longer(cols = c(deaths_all_causes, deaths_non_covid), 
               names_to = "deaths_type", values_to = "deaths") %>%
  mutate(  # subtract mean from all figures to flatten graph
    deaths = deaths - deaths_mean,
    deaths_min = deaths_min - deaths_mean,
    deaths_max = deaths_max - deaths_mean
  ) %>%
  ggplot(aes(x = date_w_c)) +
  geom_vline(xintercept = compute_start_date_from_week_number(week_number = 1, year_number = 2021), linetype = "dashed", colour="grey50") +  # start of 2021
  geom_vline(xintercept = compute_start_date_from_week_number(week_number = 1, year_number = 2022), linetype = "dashed", colour="grey50") +  # start of 2022
  scale_x_date(date_labels = "%d-%m-%y", date_breaks = "12 weeks", limits = c(earliest_date, most_recent_date_available_2022)) +
  geom_ribbon(aes(ymin = deaths_min, ymax = deaths_max, fill = "#4477aa"), alpha = 0.5) +
  geom_line(aes(y = deaths, colour = deaths_type)) +
  geom_line(aes(y = 0, linetype = "dashed"), colour="grey20") +
  facet_grid(~place_of_death) +
  scale_colour_manual(values = c("red","blue"),  # custom legend for the two lines
                      labels = c("All deaths", 
                                 "Non Covid-19 deaths"),
                      guide = guide_legend(label.hjust = 0.5, override.aes = list(size = 5))
                      ) +
  scale_linetype_manual(values = c("dashed"), labels = "Weekly average (scaled to 0)") +
  scale_fill_manual(values = c("#4477aa"), labels = "Historic weekly minima/maxima") +
  theme(
    legend.position = "top",
    legend.title = element_blank(),
    plot.caption = element_text(size = 10, colour = "gray60"),
    plot.margin = margin(5, 15, 5, 5),
    axis.text.x = element_text(angle = 60, colour = "gray40", vjust=1, hjust=1)
  ) +
  labs(x = NULL,
       y = "Deaths (difference from weekly average)",
       subtitle = date_range_text,
       caption = paste0(c(death_registrations_text,removed_other_category_text,source_nrs_text), collapse="\n")
       ) +
  annotate(geom = "text", x=ymd("2021-01-28"), y=-250, label = "2021", hjust = 0, colour = "grey40") +
  annotate(geom = "text", x=ymd("2022-01-07"), y=-250, label = "'22", hjust = 0, colour = "grey40") +
  NULL

fig_place_of_death_deviation_from_mean %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_place_of_death_deviation_from_mean", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 28, height = 14, dpi = 300, units = "cm")
```


# Home deaths by geography over time: 2020-2022, 4-week average

## Home deaths by HB, 4-week average

```{r}
(fig_home_deaths_over_time_by_hb_4_week_average <-
  merged_deaths_hb %>%
  filter(place_of_death == "Home & other non-institution") %>%
  mutate(ref_area = factor(x = ref_area, levels = order_hb_by_population)) %>%  # arrange hb/la by population size
  pivot_longer(cols = c(ma4w_deaths_all_causes, ma4w_deaths_non_covid), 
               names_to = "deaths_type", values_to = "deaths") %>% 
  ggplot(aes(x = date_w_c)) +
  scale_x_date(date_labels = "%d-%m-%y", date_breaks = "12 weeks", limits = c(earliest_date, most_recent_date_available_2022)) +
  geom_ribbon(aes(ymin = ma4w_deaths_min, ymax = ma4w_deaths_max, fill = "#4477aa"), alpha = 0.5) +
  # geom_ribbon(aes(ymin = deaths_min, ymax = deaths_max), fill = "#4477aa", alpha = 0.5) +
  geom_line(aes(y = deaths, colour = deaths_type)) +
  geom_line(aes(y = ma4w_deaths_mean, linetype = "dashed"), size = 0.2) +
  geom_vline(xintercept = compute_start_date_from_week_number(week_number = 1, year_number = 2021), linetype = "dashed", colour="grey50") +  # start of 2021
  geom_vline(xintercept = compute_start_date_from_week_number(week_number = 1, year_number = 2022), linetype = "dashed", colour="grey50") +  # start of 2022
  # scale_x_continuous(breaks = seq(0,60,by=10)) +
  facet_wrap(~ref_area, scales = "free_y") +
  scale_colour_manual(values = c("red","blue"),  # custom legend for the two lines
                      labels = c("All deaths", 
                                 "Non Covid-19 deaths"),
                      guide = guide_legend(label.hjust = 0.5, override.aes = list(size = 5))
                      ) +
  scale_linetype_manual(values = c("dashed"), labels = "Weekly average") +
  scale_fill_manual(values = c("#4477aa"), labels = "Historic weekly minima/maxima") +
  theme(
    legend.position = "top",
    legend.title = element_blank(),
    plot.caption = element_text(size = 10, colour = "gray60"),
    axis.text.x = element_text(angle = 60, colour = "gray40", vjust=1, hjust=1)
    ) +
  labs(x = NULL,
       y = "Deaths (average of past 4 weeks)",
       title = "Deaths at Home*: 4-week average by NHS Health Board",
       subtitle = date_range_text,
       caption = paste0(c(
         "*Home or other non-institutional setting", vertical_line_text, vertical_scale_differs_between_panels_text,death_registrations_text,source_nrs_text
         ), collapse="\n")
       ) +
  ## annotate historic range
  annotate(geom = "text", x=ymd("2021-01-07"), y=0, label = "2021", hjust = 0, vjust = -1, colour = "grey40") +
  annotate(geom = "text", x=ymd("2022-01-07"), y=0, label = "'22", hjust = 0, vjust = -1, colour = "grey40") +
  NULL
 )

fig_home_deaths_over_time_by_hb_4_week_average %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_home_deaths_4week_average_over_time_by_hb", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 30, height = 20, dpi = 300, units = "cm")
```

## Home deaths by LA, 4-week average

```{r}
(fig_home_deaths_over_time_by_la_4_week_average <-
  merged_deaths_la %>%
  filter(place_of_death == "Home & other non-institution") %>%
  mutate(ref_area = factor(x = ref_area, levels = order_la_by_population)) %>%  # arrange la/la by population size
  pivot_longer(cols = c(ma4w_deaths_all_causes, ma4w_deaths_non_covid), 
               names_to = "deaths_type", values_to = "deaths") %>% 
  ggplot(aes(x = date_w_c)) +
  scale_x_date(date_labels = "%d-%m-%y", date_breaks = "12 weeks", limits = c(earliest_date, most_recent_date_available_2022)) +
  geom_ribbon(aes(ymin = ma4w_deaths_min, ymax = ma4w_deaths_max, fill = "#4477aa"), alpha = 0.5) +
  # geom_ribbon(aes(ymin = deaths_min, ymax = deaths_max), fill = "#4477aa", alpha = 0.5) +
  geom_line(aes(y = deaths, colour = deaths_type)) +
  geom_line(aes(y = ma4w_deaths_mean, linetype = "dashed"), size = 0.2) +
  geom_vline(xintercept = compute_start_date_from_week_number(week_number = 1, year_number = 2021), linetype = "dashed", colour="grey50") +  # start of 2021
  geom_vline(xintercept = compute_start_date_from_week_number(week_number = 1, year_number = 2022), linetype = "dashed", colour="grey50") +  # start of 2022
  # scale_x_continuous(breaks = seq(0,60,by=10)) +
  facet_wrap(~ref_area, scales = "free_y") +
  scale_colour_manual(values = c("red","blue"),  # custom legend for the two lines
                      labels = c("All deaths", 
                                 "Non Covid-19 deaths"),
                      guide = guide_legend(label.hjust = 0.5, override.aes = list(size = 5))
                      ) +
  scale_linetype_manual(values = c("dashed"), labels = "Weekly average") +
  scale_fill_manual(values = c("#4477aa"), labels = "Historic weekly minima/maxima") +
  theme(
    legend.position = "top",
    legend.title = element_blank(),
    plot.caption = element_text(size = 10, colour = "gray60"),
    axis.text.x = element_text(angle = 60, colour = "gray40", vjust=1, hjust=1)
    ) +
  labs(x = NULL,
       y = "Deaths (average of past 4 weeks)",
       title = "Deaths at Home*: 4-week average by Scottish Local Authority",
       subtitle = date_range_text,
       caption = paste0(c(
         "*Home or other non-institutional setting", vertical_line_text, vertical_scale_differs_between_panels_text,death_registrations_text,source_nrs_text
         ), collapse="\n")
       ) +
  ## annotate historic range
  annotate(geom = "text", x=ymd("2021-01-07"), y=0, label = "2021", hjust = 0, vjust = -1, colour = "grey40") +
  annotate(geom = "text", x=ymd("2022-01-07"), y=0, label = "'22", hjust = 0, vjust = -1, colour = "grey40") +
  NULL
 )

fig_home_deaths_over_time_by_la_4_week_average %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_home_deaths_4week_average_over_time_by_la", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 40, height = 20, dpi = 300, units = "cm")
```

# Geographical variations

## Proportion of deaths by place, by HB

```{r}
(fig_proportion_of_deaths_by_place_by_hb <-
  proportions_of_deaths_by_place_by_geography %>%
  filter(geography == "hb") %>%
  mutate(place_of_death = factor(x = place_of_death, levels = order_of_place_of_death_levels[c(1,3,2,4)])) %>%  # move home to 2nd position to match order in plot
  mutate(ref_area = factor(x = ref_area, levels = order_hb_by_population)) %>%  # arrange hb/la by population size
  ggplot(., aes(x=year, y=proportion_of_total, colour=place_of_death)) +
  geom_point(aes(size = place_of_death)) +
  geom_line(aes(size = place_of_death)) +
  geom_text(data = ~filter(.x, year==2022), aes(x=2022.2, y=proportion_of_total, label="*"), inherit.aes = FALSE) +
  facet_rep_wrap(~ ref_area, repeat.tick.labels = TRUE) +
  scale_size_manual(values = c(1,1.8,1,1), name = "Place of death", labels = order_of_place_of_death_levels[c(1,3,2,4)]) +
  scale_x_continuous(breaks = sort(unique(proportions_of_deaths_by_place_by_geography$year))) +
  scale_y_continuous(label = function(x) scales::percent(x, accuracy = 1)) +
  scale_colour_viridis_d(option="C", name="Place of death", labels = order_of_place_of_death_levels[c(1,3,2,4)]) +
  theme(
    legend.position = "top",
    legend.text = element_text(size = 12),
    plot.caption = element_text(size = 10, colour = "gray60"),
    panel.border = element_rect(fill = NA, colour = "gray80"),  # draw a transparent rectangle as the border
    strip.background = element_rect(fill = NA, colour = "gray80"),
    axis.text.x = element_text(angle = 45, hjust = 1)
    ) +
  guides(colour = guide_legend(nrow=2, title = NULL), 
         size = guide_legend(nrow=2, title = NULL)) +
  labs(
    x = NULL, y= "Proportion of yearly deaths (%)",
    subtitle = paste0("* ",only_2022_text),
    caption = paste0(c("Health boards sorted by 2020 population estimate.",death_registrations_text,source_nrs_text),collapse="\n")
    ) +
  NULL)

fig_proportion_of_deaths_by_place_by_hb %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_proportion_of_deaths_by_place_by_hb", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 30, height = 25, dpi = 300, units = "cm")
```

## Proportion of deaths by place, by LA

```{r}
(fig_proportion_of_deaths_by_place_by_la <-
  proportions_of_deaths_by_place_by_geography %>%
  filter(geography == "la") %>%
  mutate(place_of_death = factor(x = place_of_death, levels = order_of_place_of_death_levels[c(1,3,2,4)])) %>%  # move home to 2nd position to match order in plot
  mutate(ref_area = factor(x = ref_area, levels = order_la_by_population)) %>%  # arrange la/la by population size
  ggplot(., aes(x=year, y=proportion_of_total, colour=place_of_death)) +
  geom_point(aes(size = place_of_death)) +
  geom_line(aes(size = place_of_death)) +
  geom_text(data = ~filter(.x, year==2022), aes(x=2022.2, y=proportion_of_total, label="*"), inherit.aes = FALSE) +
  facet_rep_wrap(~ ref_area, repeat.tick.labels = TRUE) +
  scale_size_manual(values = c(1,1.8,1,1), name = "Place of death", labels = order_of_place_of_death_levels[c(1,3,2,4)]) +
  scale_x_continuous(breaks = sort(unique(proportions_of_deaths_by_place_by_geography$year))) +
  scale_y_continuous(label = function(x) scales::percent(x, accuracy = 1)) +
  scale_colour_viridis_d(option="C", name="Place of death", labels = order_of_place_of_death_levels[c(1,3,2,4)]) +
  theme(
    legend.position = "top",
    legend.text = element_text(size = 12),
    plot.caption = element_text(size = 10, colour = "gray60"),
    panel.border = element_rect(fill = NA, colour = "gray80"),  # draw a transparent rectangle as the border
    strip.background = element_rect(fill = NA, colour = "gray80"),
    axis.text.x = element_text(angle = 45, hjust = 1)
    ) +
  guides(colour = guide_legend(nrow=2, title = NULL), 
         size = guide_legend(nrow=2, title = NULL)) +
  labs(
    x = NULL, y= "Proportion of yearly deaths (%)",
    subtitle = paste0("* ",only_2022_text),
    caption = paste0(c("Local Authorities sorted by 2020 population estimate.",death_registrations_text,source_nrs_text),collapse="\n")
    ) +
  NULL)

fig_proportion_of_deaths_by_place_by_la %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_proportion_of_deaths_by_place_by_la", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 30, height = 25, dpi = 300, units = "cm")
```

## Home deaths only, HB

```{r}
(fig_proportion_of_deaths_at_home_by_hb <-
  proportions_of_deaths_by_place_by_geography %>%
  filter(geography == "hb") %>%
  filter(place_of_death == "Home & other non-institution") %>%
  left_join(merged_proportions_of_deaths_by_place %>% select(year, place_of_death, proportion_scotland = proportion_of_total), by = c("year","place_of_death")) %>%
  mutate(place_of_death = factor(x = place_of_death, levels = order_of_place_of_death_levels[c(1,3,2,4)])) %>%  # move home to 2nd position to match order in plot
  mutate(ref_area = factor(x = ref_area, levels = order_hb_by_population)) %>%  # arrange hb/la by population size
  pivot_longer(cols = c(proportion_of_total, proportion_scotland), names_to = "measure", values_to = "proportion_of_total") %>%
  mutate(measure = if_else(measure == "proportion_of_total", true = "Health board", false = "Scotland")) %>%
  ggplot(., aes(x=year, y=proportion_of_total, linetype = measure)) +
  geom_point() +
  geom_line() +
  geom_text(data = ~filter(.x, year==2022), aes(x=2022.2, y=proportion_of_total, label="*"), inherit.aes = FALSE) +
  facet_rep_wrap(~ ref_area, repeat.tick.labels = TRUE) +
  scale_size_manual(values = c(1,1.8,1,1), name = "Place of death", labels = order_of_place_of_death_levels[c(1,3,2,4)]) +
  scale_x_continuous(breaks = sort(unique(proportions_of_deaths_by_place_by_geography$year))) +
  scale_y_continuous(label = function(x) scales::percent(x, accuracy = 1)) +
  scale_colour_viridis_d(option="C", name="Place of death", labels = order_of_place_of_death_levels[c(1,3,2,4)]) +
  theme(
    legend.position = "top",
    legend.text = element_text(size = 12),
    plot.caption = element_text(size = 10, colour = "gray60"),
    panel.border = element_rect(fill = NA, colour = "gray80"),  # draw a transparent rectangle as the border
    strip.background = element_rect(fill = NA, colour = "gray80"),
    axis.text.x = element_text(angle = 45, hjust = 1)
    ) +
  labs(
    linetype = NULL,
    x = NULL, y= "Proportion of yearly deaths that happened at home or other non-institution (%)",
    subtitle = paste0("* ",only_2022_text),
    caption = paste0(c("Health boards sorted by 2020 population estimate.",death_registrations_text,source_nrs_text),collapse="\n")
    ) +
  NULL)

fig_proportion_of_deaths_at_home_by_hb %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_proportion_of_deaths_at_home_by_hb", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 30, height = 25, dpi = 300, units = "cm")
```

## Home deaths only, LA

```{r}
(fig_proportion_of_deaths_at_home_by_la <-
  proportions_of_deaths_by_place_by_geography %>%
  filter(geography == "la") %>%
  filter(place_of_death == "Home & other non-institution") %>%
  left_join(merged_proportions_of_deaths_by_place %>% select(year, place_of_death, proportion_scotland = proportion_of_total), by = c("year","place_of_death")) %>%
  mutate(place_of_death = factor(x = place_of_death, levels = order_of_place_of_death_levels[c(1,3,2,4)])) %>%  # move home to 2nd position to match order in plot
  mutate(ref_area = factor(x = ref_area, levels = order_la_by_population)) %>%  # arrange la/la by population size
  pivot_longer(cols = c(proportion_of_total, proportion_scotland), names_to = "measure", values_to = "proportion_of_total") %>%
  mutate(measure = if_else(measure == "proportion_of_total", true = "Health board", false = "Scotland")) %>%
  ggplot(., aes(x=year, y=proportion_of_total, linetype = measure)) +
  geom_point() +
  geom_line() +
  geom_text(data = ~filter(.x, year==2022), aes(x=2022.2, y=proportion_of_total, label="*"), inherit.aes = FALSE) +
  facet_rep_wrap(~ ref_area, repeat.tick.labels = TRUE) +
  scale_size_manual(values = c(1,1.8,1,1), name = "Place of death", labels = order_of_place_of_death_levels[c(1,3,2,4)]) +
  scale_x_continuous(breaks = sort(unique(proportions_of_deaths_by_place_by_geography$year))) +
  scale_y_continuous(label = function(x) scales::percent(x, accuracy = 1)) +
  scale_colour_viridis_d(option="C", name="Place of death", labels = order_of_place_of_death_levels[c(1,3,2,4)]) +
  theme(
    legend.position = "top",
    legend.text = element_text(size = 12),
    plot.caption = element_text(size = 10, colour = "gray60"),
    panel.border = element_rect(fill = NA, colour = "gray80"),  # draw a transparent rectangle as the border
    strip.background = element_rect(fill = NA, colour = "gray80"),
    axis.text.x = element_text(angle = 45, hjust = 1)
    ) +
  labs(
    linetype = NULL,
    x = NULL, y= "Proportion of yearly deaths that happened at home or other non-institution (%)",
    subtitle = paste0("* ",only_2022_text),
    caption = paste0(c("Local Authorities sorted by 2020 population estimate.",death_registrations_text,source_nrs_text),collapse="\n")
    ) +
  NULL)

fig_proportion_of_deaths_at_home_by_la %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_proportion_of_deaths_at_home_by_la", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 30, height = 25, dpi = 300, units = "cm")
```

# Map-based visualisations

## Re-merge weekly deaths with 2015-2019 data for 2022 for LA & HB

```{r}
## merge the 2015-2019 period historical weekly averages to 2022 data
merged_deaths_la_historic_period_2015_2019 <-
  bind_rows(
    merged_deaths_la %>% filter(year %in% 2020:2021),
    merged_deaths_la %>% filter(year == 2022) %>%
      select(-c(deaths_mean, deaths_min, deaths_max)) %>%
      mutate(historic_period = "2015-2019") %>%
      left_join(historical_weekly_average_la, by = c("week_number", "place_of_death", "ref_area", "historic_period"))
  ) %>%
  left_join(weekly_covid_cases_la, by = c("year","week_number","date_w_c","week_number_run_over","ref_area"))

merged_deaths_hb_historic_period_2015_2019 <-
  bind_rows(
    merged_deaths_hb %>% filter(year %in% 2020:2021),
    merged_deaths_hb %>% filter(year == 2022) %>%
      select(-c(deaths_mean, deaths_min, deaths_max)) %>%
      mutate(historic_period = "2015-2019") %>%
      left_join(historical_weekly_average_hb, by = c("week_number", "place_of_death", "ref_area", "historic_period"))
  ) %>%
  left_join(weekly_covid_cases_hb, by = c("year","week_number","date_w_c","week_number_run_over","ref_area"))
```


## Home deaths increase since 2019 by LA

For this we can take the total annual deaths in each LA and compare to historical figures, showing the ratio for each year so far; alternatively we can also average over 2020-2022, and compare that to the average!
Because we only have partial data for 2022, we need to employ the weekly comparison method - 

```{r}
(fig_map_home_deaths_increase_from_2020_la <-
  merged_deaths_la_historic_period_2015_2019 %>%
  filter(historic_period == "2015-2019") %>%
  group_by(ref_area, place_of_death) %>%
  summarise(
    ratio_deaths_to_historic = sum(deaths_all_causes, na.rm=TRUE) / sum(deaths_mean, na.rm=TRUE),
    percent_increase = ratio_deaths_to_historic - 1,
    .groups = "drop"
  ) %>%
  filter(place_of_death == "Home & other non-institution") %>%
  left_join(shapefile_la, by=c("ref_area"="LAD20NM")) %>%
  ggplot(aes(geometry=geometry, fill=percent_increase), colour="grey10") +
  geom_sf(colour="grey10") +
  # scale_fill_viridis_b(limits = c(minimum_ratio_between_hb_and_la_home_deaths-1, maximum_ratio_between_hb_and_la_home_deaths-1), labels = function(x) scales::percent(x, accuracy = 1)) +
  scale_fill_viridis_b(limits = c(0, 0.6), labels = function(x) scales::percent(x, accuracy = 1), direction = -1) +
  theme(axis.text = element_blank(), panel.grid = element_blank()) +
  labs(x="", y="",
       title = str_wrap("Increased home deaths since the start of 2020 relative to historical mean 2015-2019, by Local Authority", width=40),
       # subtitle = str_wrap("A ratio of 1 means there was no increase; A ratio of 1.6 means there was a 60% increase of home deaths in 2020 over the mean 2015-2019.", width = 80),
       # caption = paste0(c(areas_relatively_higher_number_home_deaths_text, home_deaths_ratio_text, source_nrs_text), collapse="\n"),
       caption = paste0(c(only_2022_text,source_nrs_text), collapse="\n"),
       fill = "Home death\nincrease relative\nto 2015-2019"
       ) +
  NULL)

fig_map_home_deaths_increase_from_2020_la %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_map_home_deaths_increase_from_2020_la", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 13, height = 14, dpi = 300, units = "cm")
```

## Home deaths increase since 2019 by HB

```{r}
(fig_map_home_deaths_increase_from_2020_hb <-
  merged_deaths_hb_historic_period_2015_2019 %>%
  filter(historic_period == "2015-2019") %>%
  group_by(ref_area, place_of_death) %>%
  summarise(
    ratio_deaths_to_historic = sum(deaths_all_causes, na.rm=TRUE) / sum(deaths_mean, na.rm=TRUE),
    percent_increase = ratio_deaths_to_historic - 1,
    .groups = "drop"
  ) %>%
  filter(place_of_death == "Home & other non-institution") %>%
  left_join(shapefile_hb_uk_wide, by=c("ref_area"="name")) %>%
  ggplot(aes(geometry=geometry, fill=percent_increase), colour="grey10") +
  geom_sf(colour="grey10") +
  # scale_fill_viridis_b(limits = c(minimum_ratio_between_hb_and_hb_home_deaths-1, maximum_ratio_between_hb_and_hb_home_deaths-1), labels = function(x) scales::percent(x, accuracy = 1)) +
  scale_fill_viridis_b(limits = c(0, 0.6), labels = function(x) scales::percent(x, accuracy = 1), direction = -1) +
  theme(axis.text = element_blank(), panel.grid = element_blank(), aspect.ratio = 1.4) +
  labs(x="", y="",
       title = str_wrap("Increased home deaths since the start of 2020 relative to historical mean 2015-2019, by NHS Health Board", width=40),
       # subtitle = str_wrap("A ratio of 1 means there was no increase; A ratio of 1.6 means there was a 60% increase of home deaths in 2020 over the mean 2015-2019.", width = 80),
       # caption = paste0(c(areas_relatively_higher_number_home_deaths_text, home_deaths_ratio_text, source_nrs_text), collapse="\n"),
       caption = paste0(c(only_2022_text,source_nrs_text), collapse="\n"),
       fill = "Home death\nincrease relative\nto 2015-2019"
       ) +
  NULL)

fig_map_home_deaths_increase_from_2020_hb %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_map_home_deaths_increase_from_2020_hb", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 13, height = 14, dpi = 300, units = "cm")
```


## Home deaths increase since 2019 by LA, by year

For this we can take the total annual deaths in each LA and compare to historical figures, showing the ratio for each year so far; alternatively we can also average over 2020-2022, and compare that to the average!
Because we only have partial data for 2022, we need to employ the weekly comparison method - 

```{r}
(fig_map_home_deaths_increase_by_year_la <-
  merged_deaths_la_historic_period_2015_2019 %>%
  filter(historic_period == "2015-2019") %>%
  group_by(year, ref_area, place_of_death) %>%
  summarise(
    ratio_deaths_to_historic = sum(deaths_all_causes, na.rm=TRUE) / sum(deaths_mean, na.rm=TRUE),
    percent_increase = ratio_deaths_to_historic - 1,
    .groups = "drop"
  ) %>%
  filter(place_of_death == "Home & other non-institution") %>%
  left_join(shapefile_la, by=c("ref_area"="LAD20NM")) %>%
  ggplot(aes(geometry=geometry, fill=percent_increase), colour="grey10") +
  geom_sf(colour="grey10") +
  scale_fill_viridis_b(limits = c(0, 0.6), labels = function(x) scales::percent(x, accuracy = 1), direction = -1) +
  theme(
    axis.text = element_blank(), 
    panel.grid = element_blank(),
    ) +
  facet_wrap(~year, nrow = 1) +
  labs(x="", y="",
       title = "Increased home deaths since the start of 2020 relative to historical mean 2015-2019, by Local Authority",
       caption = paste0(c(only_2022_text,source_nrs_text), collapse="\n"),
       fill = "Home death\nincrease relative\nto 2015-2019"
       ) +
  NULL)

fig_map_home_deaths_increase_by_year_la %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_map_home_deaths_increase_by_year_la", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 32, height = 18, dpi = 300, units = "cm")
```

## Home deaths increase vs. covid cases by LA, all deaths since 2019

```{r}
(fig_map_covid_cases_from_2020_la <-
  weekly_covid_cases_la %>%
  group_by(ref_area) %>%
  summarise(
    ratio_covid_cases = max(crude_rate_positive_per100k),
    .groups = "drop"
  ) %>% 
  left_join(shapefile_la, by=c("ref_area"="LAD20NM")) %>%
  ggplot(aes(geometry=geometry, fill=ratio_covid_cases), colour="grey10") +
  geom_sf(colour="grey10") +
  scale_fill_viridis_b(labels = function(x) format(x, big.mark=","), direction = -1) +
  theme(axis.text = element_blank(), panel.grid = element_blank()) +
  labs(x="", y="",
       title = str_wrap("Total COVID-19 cases since the start of 2020, by Local Authority", width=40),
       subtitle = "",
       caption = paste0(c(only_2022_text,crude_rate_text,source_phs_text), collapse="\n"),
       fill = str_wrap("Cases per 100,000 population", width = 15)
       ) +
  NULL)

fig_map_covid_cases_from_2020_la %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_map_covid_cases_from_2020_la", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 13, height = 14, dpi = 300, units = "cm")

## combine maps
(fig_map_home_deaths_increase_vs_covid_case_from_2020_la <-
  wrap_plots(
    fig_map_home_deaths_increase_from_2020_la +
      theme(plot.margin = margin(0,0,0,0), legend.box.margin = margin(0,0,0,0))
      ,
    fig_map_covid_cases_from_2020_la +
      theme(plot.margin = margin(0,0,0,0), legend.box.margin = margin(0,0,0,0))
  )
)

fig_map_home_deaths_increase_vs_covid_case_from_2020_la %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_map_home_deaths_increase_vs_covid_case_from_2020_la", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 24, height = 16, dpi = 300, units = "cm")
```


## Home deaths increase since 2019 by HB, by year

See above for how this was done for LA!

```{r}
(fig_map_home_deaths_increase_by_year_hb <-
  merged_deaths_hb_historic_period_2015_2019 %>%
  filter(historic_period == "2015-2019") %>%
  group_by(year, ref_area, place_of_death) %>%
  summarise(
    ratio_deaths_to_historic = sum(deaths_all_causes, na.rm=TRUE) / sum(deaths_mean, na.rm=TRUE),
    percent_increase = ratio_deaths_to_historic - 1,
    .groups = "drop"
  ) %>%
  filter(place_of_death == "Home & other non-institution") %>%
  left_join(shapefile_hb_uk_wide, by=c("ref_area"="name")) %>%
  ggplot(aes(geometry=geometry, fill=percent_increase), colour="grey10") +
  geom_sf(colour="grey10") +
  scale_fill_viridis_b(limits = c(0, 0.6), labels = function(x) scales::percent(x, accuracy = 1), direction = -1) +
  theme(
    axis.text = element_blank(), 
    panel.grid = element_blank(),
    aspect.ratio = 1.4
    ) +
  facet_wrap(~year, nrow = 1) +
  labs(x="", y="",
       title = "Increased home deaths since the start of 2020 relative to historical mean 2015-2019, by NHS Health Board",
       caption = paste0(c(only_2022_text,source_nrs_text), collapse="\n"),
       fill = "Home death\nincrease relative\nto 2015-2019"
       ) +
  NULL)

fig_map_home_deaths_increase_by_year_hb %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_map_home_deaths_increase_by_year_hb", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 32, height = 18, dpi = 300, units = "cm")
```

## Home deaths increase vs. covid cases by HB, all deaths since 2019

```{r}
(fig_map_covid_cases_from_2020_hb <-
  weekly_covid_cases_hb %>%
  group_by(ref_area) %>%
  summarise(
    ratio_covid_cases = max(crude_rate_positive_per100k),
    .groups = "drop"
  ) %>% 
  left_join(shapefile_hb_uk_wide, by=c("ref_area"="name")) %>%
  ggplot(aes(geometry=geometry, fill=ratio_covid_cases), colour="grey10") +
  geom_sf(colour="grey10") +
  scale_fill_viridis_b(labels = function(x) format(x, big.mark=","), direction = -1) +
  theme(
    axis.text = element_blank(), 
    panel.grid = element_blank(),
    aspect.ratio = 1.4
    ) +
  labs(x="", y="",
       title = str_wrap("Total COVID-19 cases since the start of 2020, by NHS Health Board", width=40),
       subtitle = "",
       caption = paste0(c(only_2022_text,crude_rate_text,source_phs_text), collapse="\n"),
       fill = str_wrap("Cases per 100,000 population", width = 15)
       ) +
  NULL)

fig_map_covid_cases_from_2020_hb %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_map_covid_cases_from_2020_hb", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 13, height = 14, dpi = 300, units = "cm")

## combine maps
(fig_map_home_deaths_increase_vs_covid_case_from_2020_hb <-
  wrap_plots(
    fig_map_home_deaths_increase_from_2020_hb +
      theme(plot.margin = margin(0,0,0,0), legend.box.margin = margin(0,0,0,0))
      ,
    fig_map_covid_cases_from_2020_hb +
      theme(plot.margin = margin(0,0,0,0), legend.box.margin = margin(0,0,0,0))
  )
)

fig_map_home_deaths_increase_vs_covid_case_from_2020_hb %>%
save_output_file(filename = file.path(dir_outputs, paste0(c("fig_map_home_deaths_increase_vs_covid_case_from_2020_hb", latest_data_modified_date), collapse = "_")), extensions = c(".pdf",".png"), plot = ., width = 24, height = 16, dpi = 300, units = "cm")
```

### LA covid rates over time

I didn't finish this plot because the scale goes from 500 per 100k to 25k per 100k, which is a pain to depict in a meaningful way. Mayeb with a separate scale for each plot?

```{r}
## the problem with this plot is that there were between 500 per 100k cases to 25k per 100k cases over time and over LAs - how do we visualise that?
(fig_map_covid_cases_by_year_la <-
  weekly_covid_cases_la %>%
  left_join(population_estimate_la_2019 %>% rename(population_estimate = all_ages, year_estimate = year), by = c("ref_area"="la")) %>%
  group_by(ref_area, year, population_estimate) %>%
  summarise(
    cumulative_cases = sum(weekly_positive, na.rm=TRUE),
    ratio_covid_cases = cumulative_cases / population_estimate * 1e5,
    .groups = "drop"
  ) %>%
  distinct %>%
  left_join(shapefile_la, by=c("ref_area"="LAD20NM")) %>%
  ggplot(aes(geometry=geometry, fill=ratio_covid_cases), colour="grey10") +
  geom_sf(colour="grey10") +
  scale_fill_viridis_b(labels = function(x) format(x, big.mark=","), direction = -1) +
  theme(axis.text = element_blank(), panel.grid = element_blank()) +
  facet_wrap(~year, nrow = 1) +
  labs(x="", y="",
       title = str_wrap("Total COVID-19 cases since the start of 2020 per 100,000 population, by Local Authority", width=50),
       subtitle = "",
       caption = paste0(c(source_phs_text), collapse="\n"),
       fill = str_wrap("Cases per 100,000 population", width = 15)
       ) +
  NULL)
```


# Cumulative deaths at home over time

For this visualisation, we'll compare home deaths over time (e.g. years 2020, 2021, and 2022) with their historic period annual average, at HB-level. For this, we need to calculate the 2022 rate to be comparable to the complete data for years 2020 & 2021 - this is achieved by taking the sum of deaths in 2022 and dividing by the sum of the weekly average deaths in its historic period

```{r}
#TODO: continue working on this visualisation
#TODO: figure out some interesting time points to visualise
#TODO: maybe this could be done as a shiny widget? with a date slider and a selection of visualisations: map of covid cases, 
merged_deaths_hb %>%
  # filter(week_number %in% 1:4) %>%
  group_by(year, ref_area, place_of_death, historic_period) %>%
  summarise(
    deaths_all_causes = sum(deaths_all_causes, na.rm = TRUE),
    deaths_mean = sum(deaths_mean, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    ratio_annual_deaths_to_historical_mean = deaths_all_causes/deaths_mean,
    percent_increase_home_death = ratio_annual_deaths_to_historical_mean - 1
    ) %>%
  filter(
    place_of_death == "Home & other non-institution"
  ) %>%
  left_join(shapefile_hb_uk_wide, by=c("ref_area"="name")) %>%
  # ggplot(aes(geometry=geometry, fill=ratio_annual_deaths_to_historical_mean), colour="grey10") +
  ggplot(aes(geometry=geometry, fill=percent_increase_home_death), colour="grey10") +
  geom_sf(colour="grey10") +
  # scale_fill_viridis_b(limits = c(minimum_ratio_between_hb_and_la_home_deaths-1, maximum_ratio_between_hb_and_la_home_deaths-1), labels = function(x) scales::percent(x, accuracy = 1)) +
  # scale_fill_viridis_b(labels = function(x) scales::percent(x, accuracy = 1)) +
  scale_fill_binned(
    labels = function(x) scales::percent(x, accuracy = 1), 
    type = "viridis",
    n.breaks = 7
    ) +
  theme(
    axis.text = element_blank(), 
    panel.grid = element_blank(), 
    aspect.ratio = 1.4,  # needed for Scotland HB plot
    plot.margin = margin(5,5,5,5),
    # legend.position = c(1.2,0.4)  # this was manually tweaked until just right  # problem - edge gets cut
    ) +
  facet_grid(~year) +
  labs(x="", y="",
       title = str_wrap("Increased home deaths in 2020 relative to 5-year historical mean, by Health Board", width=50),
       # subtitle = str_wrap("A ratio of 1 means there was no increase; A ratio of 1.6 means there was a 60% increase of home deaths in 2020 over the mean 2015-2019.", width = 80),
       # caption = paste0(c(areas_relatively_higher_number_home_deaths_text, home_deaths_ratio_text, source_nrs_text), collapse="\n"),
       caption = paste0(c(five_year_historical_mean,death_registrations_text,source_nrs_text), collapse="\n"),
       # fill = "Ratio"
       fill = "Home death\nincrease"
       ) +
  NULL
```

