---
title: "Place of death in NRS COVID-19 deaths: data processing for analysis, 2022 data"
author: "Jan Savinc"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
  code_folding: hide
toc: true
toc_float: true
editor_options: 
  chunk_output_type: console
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Load packages

```{r, warning=FALSE, message=FALSE}
## install packages from github if not yet available!
# remotes::install_github("datasciencescotland/opendatascot", force = TRUE)
# remotes::install_github("Health-SocialCare-Scotland/phsmethods", force = TRUE)

library(tidyverse)  # for tidy workflow
library(opendatascot)  # importing data from ScotGov open data website
library(phsmethods)  # methods for working with PHS data
library(readxl)  # for reading excel files
# library(SPARQL)  # taken care of by opendatascot
library(lubridate)  # dealing with dates
library(janitor)  # for cleaning column names
library(ISOweek)  # for computing date from ISO week number + year
library(sf)  # for mapping
library(ggrepel)  # for 'mapping'repelling' labels/texst in ggplot
library(patchwork)  # for assembling plots
library(extrafont)  # for working with fonts
library(openxlsx)  # for creating xlsx files
library(knitr)  # for displaying tables in rmd

## load functions
source("./functions.R")
```


# Copyright attribution

All data used for this study were obtained from the National Records Scotland (NRS) and are Â© Crown copyright, 2020; the details of the licence can be viewed on the [Open Government Licence website](http://www.nationalarchives.gov.uk/doc/open-government-licence/open-government-licence.htm)


# Dates represent event registration, not occurrence!

From NRS website:

> All routine vital events information we publish is based on the date of registration, not the date on which the event occurred. Inevitably, of course, there are delays between the occurrence of an event and its registration.


# Load info about latest data

A separate script checks for updated data and downloads it, also updating these files with the locations of the downloaded data:

```{r}
file_data_sources <- "./table_of_data_sources.csv"
file_historical_data_sources <- "./table_of_historical_data_sources.csv"
file_case_trends_data_sources <- "./table_of_case_trends_data_sources.csv"

table_of_data_sources <- read_csv(file = file_data_sources)
table_of_historical_data_sources <- read_csv(file = file_historical_data_sources)
table_of_case_trends_data_sources <- read_csv(file = file_case_trends_data_sources)

table_of_data_sources %>%
  knitr::kable(caption = "Latest data used in this report.")

files_weekly_deaths <- set_names(x = as.list(table_of_data_sources$path_latest), nm = table_of_data_sources$short_name)
```


## Set up output directory

Because data are updated on a weekly basis, we'll have a separate directory for every week the data are updated:

```{r}
latest_data_modified_date <- strftime(max(table_of_data_sources$last_modified), format="%F")

dir_outputs <- paste0("./outputs/",latest_data_modified_date)
if (!dir.exists(dir_outputs)) dir.create(dir_outputs, recursive = TRUE)
```


# Import & wrangle data

There are several files that the data are imported from.

## Overall data

```{r}
ods_raw <- ods_dataset("deaths-involving-coronavirus-covid-19", geography = "sc")

weekly_deaths_overall <-
  # ods_dataset("deaths-involving-coronavirus-covid-19", geography = "sc") %>%
  ods_raw %>%
  make_human_readable_ref_area %>%
  clean_names() %>%
  ## below series of rename operations are a stupid way of dealing with the possibility of different variable name conventions in the ods_dataset data: sometimes they are in snake_case, and sometimes in camelCase, seemingly unpredictably
  rename_at(.vars = vars(matches("location", ignore.case = TRUE)), ~"place_of_death") %>%
  rename_at(.vars = vars(matches("period", ignore.case = TRUE)), ~"ref_period") %>%
  rename_at(.vars = vars(matches("area", ignore.case = TRUE)), ~"ref_area") %>%
  rename_at(.vars = vars(matches("measure", ignore.case = TRUE)), ~"measure_type") %>%
  rename_at(.vars = vars(matches("cause", ignore.case = TRUE)), ~"cause_of_death") %>%
  rename_at(.vars = vars(matches("sex", ignore.case = TRUE)), ~"sex") %>%
  rename_at(.vars = vars(matches("age", ignore.case = TRUE)), ~"age") %>%
  rename_at(.vars = vars(matches("value", ignore.case = TRUE)), ~"number_of_deaths") %>%  # rename so it's consistent with other data
  filter(!ref_period %in% as.character(2020:2022)) %>% # remove totals for 2020, 2021, 2022, we only want the weekly figures
  mutate(
    year = parse_integer(str_extract(ref_period, pattern="^(202[0-3])")),
    week_number = parse_integer(str_remove(ref_period, pattern = "^(202[0-3])\\-")),
    date_w_c = compute_start_date_from_week_number(week_number = week_number, year = year),
    number_of_deaths = as.numeric(number_of_deaths),  # convert to numeric!
    week_number_run_over = compute_week_run_over(week_number, year, start_year = 2020)  # invent a "run-over" week number - weeks 54+ are in 2021, weeks 106+ are in 2022
  ) %>%
  select(-c(measure_type)) %>%  #  measure_type is count for all data
  recode_place_of_death() %>%
  recode_cause_of_death() %>%
  recalculate_number_of_deaths_after_recoding_cause_of_death %>%  # not needed here probably, but no harm in including it
  pivot_wider(names_from = cause_of_death, values_from = number_of_deaths) %>%  # this dataset is well-formatted and has no implicit missing values!
  mutate(deaths_non_covid = deaths_all_causes - deaths_covid_related)  # compute non-covid deaths from the other two figures - will be NA where either is missing
```

## Sex & age

```{r}
weekly_deaths_sex_age <-  # structure here is a bit more complicated - headers in row 3, but sex & age headers in row 4
  readxl::read_excel(files_weekly_deaths$sex_age, sheet = 2, skip = 4, col_names = c("week_number","place_of_death","sex","age","cause_of_death","number_of_deaths"), guess_max = 1e5) %>%
  drop_na(number_of_deaths) %>%    # remove empty rows & one row where it's just the copyright notice
  parse_year_and_week_number_from_ad_hoc_data %>%
  recode_cause_of_death() %>%
  recalculate_number_of_deaths_after_recoding_cause_of_death %>%  # recompute the sum of deaths
  tidyr::complete(  # complete implicit missing entries and make them 0
    nesting(week_number,week_number_run_over,date_w_c,year),
    age,sex,place_of_death,cause_of_death,
    fill = list(number_of_deaths = 0)
  ) %>%
  recode_place_of_death() %>%  # this needs to be done after recoding cause of death, otherwise we also include the "all" figure which isn't included in this dataset
  pivot_wider(names_from = cause_of_death, values_from = number_of_deaths) %>%   # make separate columns for causes of death figures
  mutate(deaths_all_causes = deaths_non_covid + deaths_covid_related) %>%  # compute all cause deaths from the other two figures reported
  set_covid_and_non_covid_deaths_to_zero_before_reporting_started()
```

### Sex & age separate splits

```{r}
## compute weekly data for sex and age separately
## sum over sex or age, respectively
weekly_deaths_sex <-
  weekly_deaths_sex_age %>%
  filter(age!="all") %>%
  group_by(week_number, week_number_run_over, year, date_w_c, sex, place_of_death) %>%
  summarise(across(starts_with("deaths_"), ~sum(.x)), .groups = "drop")

weekly_deaths_age <-
  weekly_deaths_sex_age %>%
  filter(sex!="all") %>%
  group_by(week_number, week_number_run_over, year, date_w_c, age, place_of_death) %>%
  summarise(across(starts_with("deaths_"), ~sum(.x)), .groups = "drop")
```

## LA & HB

```{r}
weekly_deaths_la <- 
  read_excel(files_weekly_deaths$la, sheet = 2, skip = 2) %>% 
  clean_names %>%
  rename(week_number = week_of_occurrence, ref_area = council, place_of_death = location_of_death, number_of_deaths = deaths) %>%
  filter(!is.na(number_of_deaths)) %>%  # remove blank rows & copyright entry
  parse_year_and_week_number_from_ad_hoc_data %>%
  recode_cause_of_death() %>%
  recalculate_number_of_deaths_after_recoding_cause_of_death %>%  # recompute the sum of deaths
  tidyr::complete(
      nesting(year, week_number, week_number_run_over, date_w_c),  # these are 'identifying' variables that shouldn't be combinatorily exploded
      ref_area, cause_of_death, place_of_death,  # these are the variables we want to have all combinations of, and missing combinations are set to 0 deaths
      fill = list(number_of_deaths = 0)
      ) %>%
  recode_place_of_death() %>%  # this needs to be done before recoding cause of death, otherwise we also include the "all" figure which isn't included in this dataset
  pivot_wider(names_from = cause_of_death, values_from = number_of_deaths) %>%   # make separate columns for causes of death figures
  mutate(deaths_all_causes = deaths_non_covid + deaths_covid_related) %>%  # compute all cause deaths from the other two figures reported
  set_covid_and_non_covid_deaths_to_zero_before_reporting_started()
              quiet = FALSE)

weekly_deaths_hb <- 
  read_excel(files_weekly_deaths$hb, sheet = 2, skip = 2) %>% 
  clean_names %>%
  rename(week_number = week_of_occurrence, ref_area = health_board, place_of_death = location_of_death, number_of_deaths = deaths) %>%
  filter(!is.na(number_of_deaths)) %>%  # remove blank rows & copyright entry
  parse_year_and_week_number_from_ad_hoc_data %>%
  recode_cause_of_death() %>%
  recalculate_number_of_deaths_after_recoding_cause_of_death %>%  # recompute the sum of deaths
  tidyr::complete(
      nesting(year, week_number, week_number_run_over, date_w_c),  # these are 'identifying' variables that shouldn't be combinatorily exploded
      ref_area, cause_of_death, place_of_death,  # these are the variables we want to have all combinations of, and missing combinations are set to 0 deaths
      fill = list(number_of_deaths = 0)
      ) %>%
  recode_place_of_death() %>%  # this needs to be done before recoding cause of death, otherwise we also include the "all" figure which isn't included in this dataset
  pivot_wider(names_from = cause_of_death, values_from = number_of_deaths) %>%  # make separate columns for causes of death figures
  mutate(deaths_all_causes = deaths_non_covid + deaths_covid_related) %>%  # compute all cause deaths from the other two figures reported
  set_covid_and_non_covid_deaths_to_zero_before_reporting_started()
```

## Weekly Covid as contributory vs underlying cause of death

```{r}
weekly_covid_contributory_vs_underlying_cause <-
  readxl::read_excel(files_weekly_deaths$sex_age, sheet = 2, skip = 4, col_names = c("week_number","place_of_death","sex","age","cause_of_death","number_of_deaths"), guess_max = 1e5) %>%
  drop_na(number_of_deaths) %>%    # remove empty rows & one row where it's just the copyright notice
  parse_year_and_week_number_from_ad_hoc_data %>%
  filter(
    cause_of_death %in% c("COVID-19 contributory factor", "COVID-19 underlying cause")
  ) %>%
  tidyr::complete(  # complete implicit missing entries and make them 0
    nesting(week_number,week_number_run_over,date_w_c,year),
    age,sex,place_of_death,cause_of_death,
    fill = list(number_of_deaths = 0)
  ) %>%
  recode_place_of_death() %>%  # this needs to be done after recoding cause of death, otherwise we also include the "all" figure which isn't included in this dataset
  pivot_wider(names_from = cause_of_death, values_from = number_of_deaths) %>%   # make separate columns for causes of death figures
  clean_names() %>%
  filter(age!="all") %>%
  filter(sex!="all") %>%
  filter(place_of_death != "All") %>%
  group_by(week_number, week_number_run_over, year, date_w_c, place_of_death) %>%  # sum over age & sex
  summarise(across(starts_with("covid_"), ~sum(.x)), .groups = "drop") %>%
  ({function(x)
    bind_rows(
      x,
      x %>% 
        group_by(week_number, week_number_run_over, year, date_w_c) %>%  # sum across place of death
        summarise(across(starts_with("covid_"), ~sum(.x)), .groups = "drop") %>%
        mutate(place_of_death = "All")
    )
  })

## check that the figures actually make sense! i.e. the two figures add up to the total covid-related figure
stopifnot(
  (weekly_deaths_overall %>%
  filter(sex=="all" & age=="all") %>%
  inner_join(weekly_covid_contributory_vs_underlying_cause) %>%
  filter(deaths_covid_related != covid_19_contributory_factor + covid_19_underlying_cause) %>%
  nrow) == 0
)

annual_covid_contributory_vs_underlying_cause <-
  weekly_covid_contributory_vs_underlying_cause %>%
  group_by(year, place_of_death) %>%
  summarise(across(starts_with("covid_"), ~sum(.x)), .groups = "drop") %>%
  ({function(x)
    bind_rows(
      x %>% mutate(year = as.character(year)),
      x %>% 
        group_by(place_of_death) %>%  # sum across eyars
        summarise(across(starts_with("covid_"), ~sum(.x)), .groups = "drop") %>%
        mutate(year = "2020-2021")
    )
  }) %>%
  mutate(deaths_covid_related = covid_19_contributory_factor + covid_19_underlying_cause) %>%
  mutate(
    proportion_contributory = covid_19_contributory_factor / deaths_covid_related,
    proportion_underlying = covid_19_underlying_cause / deaths_covid_related
    )
```


## 'Main report' file

The format of the main report file has changed from what was used in 2021.

However, the main report file is still only being used for cause of death data, which simplifies parsing the file!

Causes of death are reported in `sheet 8` of the report, and include figure from 2021 and 2022. The worksheet contains data split by location of death, which are contained within different tables arranged vertically, so their boundaries need to be written out; the tables have been pre-filled for all of 2021 and 2022, so some proportion of entries will be blank for 2022.

Note that excess deaths and 5-year average deaths are computed differently between 2020-2021 and 2022:

> For data registered in 2021, any comparison to a five year average is being made with the 2015-2019 average. For 2022, the comparison is being made to the average of 2016, 2017, 2018, 2019, 2021.

> Excess deaths are calculated by comparing the current year to the five year average from previous years. NRS, along with ONS and NISRA, agreed to leave 2020 out of five year average calculations so the five-year average which is used to compare 2022 figures against covers the years 2016, 2017, 2018, 2019 and 2021. More information about this can be found in a paper published on our website (see link on the right). Moveable public holidays, when registration offices are closed, affect the number of registrations made in the published weeks and in the corresponding weeks in previous years.

### Weekly causes of death

```{r}
sheet_cause_of_death_data <- "8"

cell_ranges_for_causes_of_death_data <- list(
  "All" = "A6:V110",
  "Care home" = "A113:V217",
  "Home & other non-institution" = "A220:V324",
  "Hospital" = "A327:V431",
  "Other" = "A434:V538"
)


# TODO: complete cleaning of this bit
# TODO: canonical causes of death

# weekly_deaths_cause_of_death <-
weekly_cause_of_death_data <- 
  map_dfr(
    .x = cell_ranges_for_causes_of_death_data,
    .f = ~readxl::read_excel(files_weekly_deaths$main_report, sheet = sheet_cause_of_death_data, range = .x), 
    .id = "place_of_death"
  ) %>%
  janitor::clean_names() %>%
  rename(year = registration_year, date_w_c = week_beginning) %>%
  select(-matches("_excess$|_average$")) %>%  # we can compute excess & averages later
  pivot_longer(cols = 5:ncol(.), names_to = "name", values_to = "number_of_deaths") %>%
  filter(!str_detect(name, "all_causes")) %>%  # we can calculate that from the others
  mutate(
    year = as.integer(year),
    cause_of_death = str_remove_all(name, "_five_year_average|_deaths"),
    cause_of_death = return_pretty_cause_of_death(cause_of_death),
    date_w_c = as.Date(date_w_c),
    week_number_run_over = compute_week_run_over(week_number, year, start_year = 2020)  # invent a "run-over" week number - weeks 54+ are in 2021, weeks 106+ are in 2022
  ) %>%
  select(-name) %>%
  filter(!is.na(number_of_deaths))  # remove blank entries - these are for the current year but for dates in the future
```


### Historical causes of death

Historical here refers to the 2015-2019 period for 2020 & 2021, and 2016-2021 (skipping 2020) for 2022. There is another 'historical' dataset, which includes cause of death figures for 2020.

```{r}

```

